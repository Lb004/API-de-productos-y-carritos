<div class="cart-container">
  <h1>üõí Carrito de Compras</h1>
  
  {{#if cart.products.length}}
    <div class="cart-items">
      {{#each cart.products}}
        <div class="cart-item" data-product-id="{{this.product._id}}">
          <div class="item-details">
            <h3>{{this.product.title}}</h3>
            <p>{{this.product.description}}</p>
            <p class="item-code">C√≥digo: {{this.product.code}}</p>
          </div>
          
          <div class="item-pricing">
            <p class="item-price">${{this.product.price}}</p>
            <div class="quantity-controls">
              <label>Cantidad:</label>
              <input type="number" 
                     class="quantity-input"
                     value="{{this.quantity}}" 
                     min="1" 
                     data-cart-id="{{../cart._id}}"
                     data-product-id="{{this.product._id}}">
              <button class="btn btn-update update-quantity-btn" 
                      data-cart-id="{{../cart._id}}"
                      data-product-id="{{this.product._id}}">
                üîÑ Actualizar
              </button>
            </div>
            <p class="item-subtotal">Subtotal: ${{multiply this.product.price this.quantity}}</p>
          </div>
          
          <div class="item-actions">
            <button class="btn btn-danger delete-item-btn" 
                    data-cart-id="{{../cart._id}}"
                    data-product-id="{{this.product._id}}">
              üóëÔ∏è Eliminar
            </button>
          </div>
        </div>
      {{/each}}
    </div>
    
    <div class="cart-summary">
      <h2>Total: ${{calculateTotal cart.products}}</h2>
      <div class="cart-actions">
        <button class="btn btn-warning clear-cart-btn" data-cart-id="{{cart._id}}">
          üßπ Vaciar Carrito
        </button>
        <a href="/" class="btn btn-secondary">‚Üê Seguir Comprando</a>
      </div>
    </div>
  {{else}}
    <div class="empty-cart">
      <h2>Tu carrito est√° vac√≠o</h2>
      <a href="/" class="btn btn-primary">Descubrir Productos</a>
    </div>
  {{/if}}
</div>

<style>
.cart-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
.cart-items { margin-bottom: 30px; }
.cart-item { display: grid; grid-template-columns: 1fr auto auto; gap: 20px; background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; }
.item-price { font-size: 1.2rem; font-weight: bold; color: #667eea; }
.quantity-controls { display: flex; gap: 8px; align-items: center; }
.quantity-input { width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
.cart-summary { background: white; padding: 25px; border-radius: 10px; text-align: center; }
.cart-actions { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
.btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; }
.btn-primary { background: #667eea; color: white; }
.btn-secondary { background: #6c757d; color: white; }
.btn-warning { background: #ffc107; color: #212529; }
.btn-danger { background: #dc3545; color: white; }
.btn-update { background: #17a2b8; color: white; padding: 5px 10px; }
</style>

<script>
// ACTUALIZAR CANTIDAD
document.querySelectorAll('.update-quantity-btn').forEach(button => {
  button.addEventListener('click', async function() {
    const cartId = this.dataset.cartId;
    const productId = this.dataset.productId;
    const quantityInput = document.querySelector(`input[data-product-id="${productId}"]`);
    const quantity = parseInt(quantityInput.value);

    if (quantity <= 0) {
      alert('‚ùå La cantidad debe ser mayor a 0');
      return;
    }

    try {
      const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantity })
      });

      if (response.ok) {
        alert('‚úÖ Cantidad actualizada');
        location.reload();
      } else {
        const error = await response.json();
        alert(`‚ùå Error: ${error.message}`);
      }
    } catch (error) {
      alert(`‚ùå Error: ${error.message}`);
    }
  });
});

// ELIMINAR PRODUCTO
document.querySelectorAll('.delete-item-btn').forEach(button => {
  button.addEventListener('click', async function() {
    if (!confirm('¬øEliminar este producto?')) return;

    const cartId = this.dataset.cartId;
    const productId = this.dataset.productId;

    try {
      const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        alert('‚úÖ Producto eliminado');
        location.reload();
      }
    } catch (error) {
      alert(`‚ùå Error: ${error.message}`);
    }
  });
});

// VACIAR CARRITO
document.querySelectorAll('.clear-cart-btn').forEach(button => {
  button.addEventListener('click', async function() {
    if (!confirm('¬øVaciar todo el carrito?')) return;

    const cartId = this.dataset.cartId;

    try {
      const response = await fetch(`/api/carts/${cartId}`, { method: 'DELETE' });
      if (response.ok) {
        alert('‚úÖ Carrito vaciado');
        location.reload();
      }
    } catch (error) {
      alert(`‚ùå Error: ${error.message}`);
    }
  });
});
</script>